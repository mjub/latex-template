% -- amsthm.
\numberwithin{equation}{subsection}

% Create a whole class of new theorem environments.
\NewDocumentCommand \NewThm {s o >\TrimSpaces m >\TrimSpaces m}
  {%
    \IfValueTF{#2}
      {\newtheorem{#3\IfBooleanT{#1}{*}}{#4}[#2]}
      {\newtheorem{#3\IfBooleanT{#1}{*}}[equation]{#4}}
    \newtheorem*{#3\IfBooleanF{#1}{*}}{#4}

    % Special enviroment for lists (i.e. itemize and enumerate).
    \NewDocumentEnvironment {#3-list} {o}
      {\IfValueTF{##1}{\begin{#3}[##1]}{\begin{#3}}\leavevmode\nopagebreak}
      {\end{#3}}
    \NewDocumentEnvironment {#3-list*} {o}
      {\IfValueTF{##1}{\begin{#3*}[##1]}{\begin{#3*}}\leavevmode\nopagebreak}
      {\end{#3*}}
  }

  \newtheoremstyle {runin}
    {0pt}
    {0pt}
    {}
    {}
    {}
    {~---~}
    {0em}
    {\thmnumber{(#2)}}

  \theoremstyle{runin}
  % A dirty hack to write numbered paragraphs.
  \newtheorem{numbered}[equation]{}


\newtheoremstyle {default}
  {}
  {}
  {}
  {}
  {}
  {.~---~}
  {0em}
  {\thmname{\microtypesetup{tracking=false}\textsc{#1}\microtypesetup{tracking=true}}\thmnumber{ #2}\thmnote{ (#3)}}

\newtheoremstyle {statement}
  {}
  {}
  {\thfamily}
  {}
  {}
  {.~---~}
  {0em}
  {\textbf{\thmname{#1}\thmnumber{ #2}}\thmnote{ (#3)}}

\newtheoremstyle {other}
  {}
  {}
  {}
  {}
  {}
  {.~---~}
  {0em}
  {\thmname{\emph{#1}}\thmnumber{ #2}\thmnote{ (#3)}}

\theoremstyle{default}
\NewThm{definition}{\iflanguage{french}{Définition}{Definition}}

\theoremstyle{other}
\NewThm{exercise}{\iflanguage{french}{Exercice}{Exercise}}

% -- fancyhdr.
\renewcommand{\headrulewidth}{0pt}

% Default style.
\fancypagestyle {default}
  {%
    \fancyhf{}
    \fancyhead[LE,RO]{\small\thepage}
    \fancyhead[CE]{\small\leftmark}
    \fancyhead[RE]{\small§~\thesection}
    \fancyhead[CO]{\small\rightmark}
  }

\makeatletter
  \NewDocumentCommand \@TitleStyle {>\TrimSpaces m} {\textsc{\MakeUppercase{#1}}}

  \renewcommand{\sectionmark}[1]{\markboth{\textsc{\MakeUppercase{#1}}}{}}
  \renewcommand{\subsectionmark}[1]{\markright{\textsc{\MakeUppercase{#1}}}}

  % % Below is a dirty fix for the table of contents and the references.
  % \fancypagestyle {toc}
  %   {%
  %     \fancyhf{}
  %     \fancyhead[LE,RO]{\small\thepage}
  %     \fancyhead[CE]{\small\@TitleStyle{Contents}}
  %     \fancyhead[CO]{\small\rightmark}
  %   }

  % \fancypagestyle {bibliography}
  %   {%
  %     \fancyhf{}
  %     \fancyhead[LE,RO]{\small\thepage}
  %     \fancyhead[CE]{\small\@TitleStyle{References}}
  %     \fancyhead[CO]{\small\rightmark}
  %   }
\makeatother

% -- titlecaps.
\iflanguage{french}{}{%
  \Addlcwords
    {%
      a amid an and anti as at atop but by down for from in into like near next nor of off on onto or out over pace past per plus qua save so than the till to up upon via with yet
    }
}

% -- titlesec.
\titleformat \section [block]
  {\center\Large}
  {§~\thesection.~~}
  {0pt}
  {\MakeUppercase}
  [\endcenter]

\titleformat \subsection
  {\large}
  {\thesubsection.~~}
  {0pt}
  {\emph}

% -- titletoc.
\titlecontents {section}
  [0em]
  {\vspace{1.5em}}
  {§~\thecontentslabel.~~\MakeUppercase}
  {\MakeUppercase}
  {\normalfont\titlerule*{~.~}\contentspage}

\titlecontents {subsection}
  [3em]
  {}
  {\thecontentslabel.~~\emph}
  {}
  {\normalfont\titlerule*{~.~}\contentspage}
